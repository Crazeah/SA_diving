<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ”¹æ´»å‹• | æ½›æ°´ç¤¾</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        body { 
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px 0;
        }
        .card { 
            border: none; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            backdrop-filter: blur(10px); 
            background: rgba(255, 255, 255, 0.9); 
        }
        .btn-gradient { 
            background: linear-gradient(45deg, #2196F3, #21CBF3); 
            border: none; 
            color: white; 
            transition: transform 0.2s; 
        }
        .btn-gradient:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(33, 203, 243, 0.4); 
            color: white; 
        }
        .form-control, .form-select { 
            border-radius: 10px; 
            padding: 10px 15px; 
            border: 1px solid #ddd; 
        }
        .form-control:focus, .form-select:focus { 
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); 
            border-color: #2196F3; 
        }
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            object-fit: cover;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .required-label::after {
            content: " *";
            color: #dc3545;
        }
        .rejection-reason {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 4px solid #ff9800;
            animation: slideInDown 0.5s;
        }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-4 animate__animated animate__fadeInUp">
                <h2 class="text-center fw-bold mb-4 text-primary">âœï¸ ä¿®æ”¹æ´»å‹•å…§å®¹</h2>
                
                <!-- é¡¯ç¤ºé€€å›åŸå› ï¼ˆå°æ‡‰ UC-A09 é€€å›æµç¨‹ï¼‰ -->
                <div class="alert rejection-reason" th:if="${activity.status.name() == 'NEEDS_REVISION'}">
                    <div class="d-flex align-items-start">
                        <div class="me-3" style="font-size: 2rem;">âš ï¸</div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading fw-bold mb-2">ç®¡ç†å“¡é€€å›åŸå› </h5>
                            <p class="mb-1" th:text="${activity.rejectionReason}">è³‡æ ¼è¨­å®šä¸åˆç†ï¼Œå»ºè­°èª¿æ•´ç‚º AOW ä»¥ä¸Š</p>
                            <hr>
                            <small class="text-muted">
                                é€€å›æ™‚é–“ï¼š<span th:text="${#temporals.format(activity.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-12-09 15:30</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- è‰ç¨¿ç‹€æ…‹æç¤º -->
                <div class="alert alert-secondary" th:if="${activity.status.name() == 'DRAFTING'}">
                    <small>
                        <strong>ğŸ“ è‰ç¨¿ç‹€æ…‹ï¼š</strong>æ­¤æ´»å‹•å°šæœªé€å¯©ï¼Œä¿®æ”¹å¾Œå¯é¸æ“‡ç¹¼çºŒå„²å­˜æˆ–é€å‡ºå¯©æ ¸
                    </small>
                </div>
                
                <form id="editForm" th:action="@{/activity/update/{id}(id=${activity.id})}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="_method" value="PUT">
                    <input type="hidden" name="activityId" th:value="${activity.id}">
                    
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold required-label">æ´»å‹•æ¨™é¡Œ</label>
                            <input type="text" name="title" class="form-control" 
                                   th:value="${activity.title}"
                                   placeholder="ä¾‹ï¼šç¶ å³¶ Fun Dive ä¸‰å¤©å…©å¤œ" 
                                   maxlength="100" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold required-label">é¡åˆ¥</label>
                            <select name="category" class="form-select" required>
                                <option value="fun_dive" th:selected="${activity.category.name() == 'FUN_DIVE'}">ğŸ  Fun Dive</option>
                                <option value="course" th:selected="${activity.category.name() == 'COURSE'}">ğŸ“ èª²ç¨‹æ•™å­¸</option>
                                <option value="meeting" th:selected="${activity.category.name() == 'MEETING'}">ğŸ» ç¤¾åœ˜èšæœƒ</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold required-label">äººæ•¸ä¸Šé™</label>
                            <input type="number" name="maxParticipants" class="form-control" 
                                   th:value="${activity.maxParticipants}"
                                   min="1" max="100" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold required-label">é–‹å§‹æ™‚é–“</label>
                            <input type="datetime-local" id="startTime" name="startTime" 
                                   class="form-control"
                                   th:value="${#temporals.format(activity.startTime, 'yyyy-MM-dd\'T\'HH:mm')}"
                                   required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold required-label">çµæŸæ™‚é–“</label>
                            <input type="datetime-local" id="endTime" name="endTime" 
                                   class="form-control"
                                   th:value="${#temporals.format(activity.endTime, 'yyyy-MM-dd\'T\'HH:mm')}"
                                   required>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label fw-bold required-label">åœ°é»</label>
                            <input type="text" name="location" class="form-control" 
                                   th:value="${activity.location}"
                                   placeholder="ä¾‹ï¼šå°ç‰çƒã€ç¶ å³¶ã€å¢¾ä¸" 
                                   maxlength="100" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold required-label">è²»ç”¨ï¼ˆå…ƒï¼‰</label>
                            <input type="number" name="cost" class="form-control" 
                                   th:value="${activity.cost}"
                                   min="0" step="100" required>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-bold required-label">åƒåŠ è³‡æ ¼</label>
                            <select name="qualification" class="form-select" required>
                                <option value="ALL" th:selected="${activity.qualification.name() == 'ALL'}">ğŸŒŠ æ‰€æœ‰æœƒå“¡ï¼ˆä¸é™è­‰ç…§ï¼‰</option>
                                <option value="OW" th:selected="${activity.qualification.name() == 'OW'}">ğŸ“ Open Water ä»¥ä¸Š</option>
                                <option value="AOW" th:selected="${activity.qualification.name() == 'AOW'}">â­ Advanced Open Water ä»¥ä¸Š</option>
                                <option value="RESCUE" th:selected="${activity.qualification.name() == 'RESCUE'}">ğŸš‘ Rescue Diver ä»¥ä¸Š</option>
                                <option value="DM" th:selected="${activity.qualification.name() == 'DM'}">ğŸ‘¨â€âœˆï¸ Divemaster ä»¥ä¸Š</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">è©³ç´°å…§å®¹</label>
                            <textarea name="description" class="form-control" rows="6" 
                                      th:text="${activity.description}"
                                      placeholder="å»ºè­°åŒ…å«ï¼šé›†åˆåœ°é»ã€äº¤é€šæ–¹å¼ã€è£å‚™èªªæ˜ç­‰"></textarea>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">å®£å‚³åœ–ç‰‡</label>
                            
                            <div th:if="${activity.imageUrl}" class="mb-2">
                                <img th:src="${activity.imageUrl}" 
                                     class="img-thumbnail" 
                                     style="max-height: 200px; border-radius: 10px;"
                                     alt="ç¾æœ‰åœ–ç‰‡">
                                <p class="text-muted small mt-1">ğŸ‘† ç›®å‰çš„å®£å‚³åœ–ç‰‡</p>
                            </div>
                            
                            <input type="file" name="image" id="imageInput" class="form-control" 
                                   accept="image/jpeg,image/png,image/jpg" 
                                   onchange="previewImage(event)">
                            <small class="text-muted">è‹¥ä¸æ›´æ›åœ–ç‰‡å¯ä¸é¸æ“‡æª”æ¡ˆ</small>
                            <img id="imagePreview" alt="æ–°åœ–ç‰‡é è¦½">
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" onclick="submitForm('submit')" class="btn btn-gradient btn-lg fw-bold">
                            ğŸ“¤ å„²å­˜ä¸¦é€å‡ºå¯©æ ¸
                        </button>
                        <button type="button" onclick="submitForm('draft')" class="btn btn-outline-secondary btn-lg">
                            ğŸ’¾ åƒ…å„²å­˜ä¿®æ”¹ï¼ˆä¸é€å¯©ï¼‰
                        </button>
                        <a th:href="@{/activity/my-list}" class="btn btn-outline-secondary">
                            â† å–æ¶ˆä¸¦è¿”å›
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'æª”æ¡ˆå¤ªå¤§',
                    text: 'åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MBï¼'
                });
                event.target.value = '';
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function validateForm() {
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        
        const requiredFields = document.querySelectorAll('[required]');
        for (let field of requiredFields) {
            if (!field.value.trim()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'è«‹å¡«å¯«å®Œæ•´',
                    text: 'è«‹ç¢ºèªæ‰€æœ‰å¿…å¡«æ¬„ä½éƒ½å·²å¡«å¯«ï¼'
                });
                field.focus();
                return false;
            }
        }

        if (startTime && endTime && new Date(endTime) <= new Date(startTime)) {
            Swal.fire({
                icon: 'error',
                title: 'æ™‚é–“éŒ¯èª¤',
                text: 'çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼',
                confirmButtonColor: '#2196F3'
            });
            return false;
        }

        return true;
    }

    function submitForm(action) {
        if (!validateForm()) {
            return;
        }

        const isSubmit = action === 'submit';
        const title = isSubmit ? 'ç¢ºå®šé€å‡ºå¯©æ ¸ï¼Ÿ' : 'å„²å­˜ä¿®æ”¹ï¼Ÿ';
        const text = isSubmit ? 'ä¿®æ”¹å¾Œçš„æ´»å‹•å°‡é‡æ–°é€äº¤ç®¡ç†å“¡å¯©æ ¸' : 'å°‡å„²å­˜ç‚ºè‰ç¨¿ç‹€æ…‹ï¼Œä¸æœƒé€å¯©';
        const icon = isSubmit ? 'question' : 'info';

        Swal.fire({
            title: title,
            text: text,
            icon: icon,
            showCancelButton: true,
            confirmButtonText: isSubmit ? 'é€å‡ºå¯©æ ¸' : 'å„²å­˜',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#2196F3',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const form = document.getElementById('editForm');
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'newStatus';
                statusInput.value = isSubmit ? 'PENDING_AUDIT' : 'DRAFTING';
                form.appendChild(statusInput);

                Swal.fire({
                    title: 'è™•ç†ä¸­...',
                    html: '<div class="spinner-border text-primary" role="status"></div>',
                    allowOutsideClick: false,
                    showConfirmButton: false
                });

                // å¯¦éš›é€å‡ºï¼ˆå¾Œç«¯ä¸²å¥½å¾Œè§£é–‹ï¼‰
                // form.submit();

                // æ¸¬è©¦ç”¨
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: isSubmit ? 'å·²é‡æ–°é€å¯©ï¼' : 'å·²å„²å­˜ä¿®æ”¹',
                        text: isSubmit ? 'ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸' : 'å¯éš¨æ™‚ç¹¼çºŒç·¨è¼¯',
                        confirmButtonColor: '#2196F3'
                    }).then(() => {
                        // window.location.href = '/activity/my-list';
                    });
                }, 1500);
            }
        });
    }
</script>
</body>
</html>